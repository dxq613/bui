/*! BUI - v0.1.0 - 2013-11-18
* https://github.com/dxq613/bui
* Copyright (c) 2013 dxq613; Licensed MIT */
define("bui/uploader/button/swfButton/ajbridge",function(a){function b(a){b.superclass.constructor.call(this,a)}var c=a("bui/common"),d=a("bui/swf"),e={};return c.mix(b,{eventHandler:function(a,b){var c=e[a];c&&c.__eventHandler(a,b)},augment:function(a,b){c.isString(b)&&(b=[b]),c.isArray(b)&&c.each(b,function(b){a.prototype[b]=function(){try{return this.callSWF(b,Array.prototype.slice.call(arguments,0))}catch(a){this.fire("error",{message:a})}}})}}),c.extend(b,d),c.augment(b,{initializer:function(){b.superclass.initializer.call(this);var a=this,c=a.get("attrs"),d=c.id;e[d]=a,a.set("id",d)},__eventHandler:function(a,b){var d=this,e=b.type;switch(b.id=a,e){case"log":c.log(b.message);break;default:d.fire(e,b)}},destroy:function(){b.superclass.destroy.call(this);var a=this.get("id");e[a]&&delete e[a]}}),b.augment(b,["activate","getReady","getCoreVersion","setFileFilters","filter","setAllowMultipleFiles","multifile","browse","upload","uploadAll","cancel","getFile","removeFile","lock","unlock","setBtnMode","useHand","clear"]),c.AJBridge=b,b}),define("bui/uploader/button/filter",function(a){var b=a("bui/common"),c={msexcel:{type:"application/msexcel",ext:".xls,.xlsx"},msword:{type:"application/msword",ext:".doc,.docx"},gif:{type:"image/gif",ext:".gif"},jpeg:{type:"image/jpeg",ext:".jpg"},bmp:{type:"image/x-ms-bmp",ext:".bmp"},png:{type:"image/png",ext:".png"}};return{_getValueByDesc:function(a,d){var e=[];return b.isString(a)&&(a=a.split(",")),b.isArray(a)&&b.each(a,function(a){var b=c[a];b&&b[d]&&e.push(b[d])}),e.join(",")},getTypeByDesc:function(a){return this._getValueByDesc(a,"type")},getExtByDesc:function(a){return this._getValueByDesc(a,"ext")},getTypeByExt:function(a){var d=[];return b.isString(a)&&(a=a.split(",")),b.isArray(a)&&b.each(a,function(a){b.each(c,function(c){b.Array.indexOf(a,c.ext.split(","))>-1&&d.push(c.type)})}),d.join(",")}}}),define("bui/uploader/button/base",function(a){function b(a){return a.replace(/.*(\/|\\)/,"")}function c(a){var b=/\.[^\.]+/.exec(a)||[];return b.join("")}function d(a){var b=-1;do a/=1024,b++;while(a>99);return Math.max(a,.1).toFixed(1)+["KB","MB","GB","TB","PB","EB"][b]}function e(a){return a.id||h.guid("bui-uploader-file")}function f(){}function g(){}var h=a("bui/common"),i=(h.Component,a("bui/uploader/button/filter")),j=h.prefix,k=j+"uploader",l=k+"-button",m=l+"-text";return f.ATTRS={},f.prototype={_uiSetText:function(){var a=this,b=a.get("text"),c=a.get("textCls"),d=a.get("el").find("."+c);d.text(b)}},g.ATTRS={buttonCls:{value:l+"-wrap",view:!0},textCls:{value:m,view:!0},text:{view:!0,value:"\u4e0a\u4f20\u6587\u4ef6"},tpl:{view:!0,value:'<a href="javascript:void(0);" class="'+l+"-wrap"+'"><span class="'+m+'">{text}</span></a>'},disabled:{value:!1,setter:function(a){return this.setDisabled(a),a}},multiple:{value:!0,setter:function(a){return this.setMultiple(a),a}},filter:{value:[],setter:function(a){return this.setFilter(a),a}}},g.prototype={getExtFileData:function(a){var f=b(a.name),g=d(a.size||0),i=c(a.name);return h.mix(a,{name:f,textSize:g,ext:i,id:e(a)}),a},setMultiple:function(){},setDisabled:function(){},getFilter:function(a){if(a){var b=[],c=[],d=[];return a.desc&&(b.push(a.desc),c.push(i.getExtByDesc(a.desc)),d.push(i.getTypeByDesc(a.desc))),a.ext&&(c.push(a.ext),d.push(i.getTypeByExt(a.ext))),a.type,{desc:b.join(","),ext:c.join(","),type:d.join(",")}}},setFilter:function(){}},g.View=f,g}),define("bui/uploader/button/htmlButton",function(a){var b=a("bui/common"),c=b.Component,d=a("bui/uploader/button/base"),e=b.UA,f=c.View.extend([d.View],{},{ATTRS:{}}),g=c.Controller.extend([d],{renderUI:function(){var a=this;a._createInput()},bindUI:function(){},_createInput:function(){var a,c=this,d=c.get("buttonCls"),f=c.get("el").find("."+d),g=c.get("inputTpl"),h=c.get("name");g=b.substitute(g,{name:h}),f.append(g),a=f.find("input"),6==e.ie&&a.css("fontSize","400px"),c._bindChangeHandler(a),c.set("fileInput",a),c.setMultiple(c.get("multiple")),c.setFilter(c.get("filter"))},_bindChangeHandler:function(a){var c=this;$(a).on("change",function(d){var e=$(this).val(),f=d.target.files,g=[];f?b.each(f,function(b){g.push(c.getExtFileData({name:b.name,type:b.type,size:b.size,file:b,input:a[0]}))}):g.push(c.getExtFileData({name:e,input:a[0]})),c.fire("change",{files:g,input:this}),c.reset()})},reset:function(){var a=this,b=a.get("fileInput");return b.parent().remove(),a.set("fileInput",null),a._createInput(),a},setMultiple:function(a){var b=this,c=b.get("fileInput");return c&&c.length?(a?c.attr("multiple","multiple"):c.removeAttr("multiple"),a):!1},setFilter:function(a){var b=this,c=b.get("fileInput"),d=b.getFilter(a);return c&&c.length?(d.type&&c.attr("accept",d.type),d):!1}},{ATTRS:{inputTpl:{view:!0,value:'<div class="file-input-wrapper"><input type="file" name="{name}" hidefocus="true" class="file-input" /></div>'},fileInput:{},name:{view:!0,value:"Filedata",setter:function(a){return a&&this.get("fileInput")&&$(this.get("fileInput")).attr("name",a),a}},xview:{value:f}}},{xclass:"uploader-htmlButton"});return g}),define("bui/uploader/button/swfButton",function(a){var b=a("bui/common"),c=b.Component,d=a("bui/uploader/button/base"),e=(a("bui/uploader/type/flash"),a("bui/uploader/button/swfButton/ajbridge")),f=c.View.extend([d.View],{},{ATTRS:{}}),g=c.Controller.extend([d],{renderUI:function(){var a=this;a._initSwfUploader()},bindUI:function(){var a=this,c=a.get("swfUploader");c.on("contentReady",function(){a.fire("swfReady",{swfUploader:c}),c.on("fileSelect",function(c){var d=c.fileList,e=[];b.each(d,function(b){e.push(a.getExtFileData(b))}),a.fire("change",{files:e})}),a.setMultiple(a.get("multiple")),a.setFilter(a.get("filter"))})},_initSwfUploader:function(){var a,c=this,d=c.get("buttonCls"),f=c.get("el").find("."+d),g=c.get("flash"),h=c.get("swfTpl");b.mix(g,{render:$(h).appendTo(f)}),a=new e(g),c.set("swfUploader",a)},setMultiple:function(a){var b=this,c=b.get("swfUploader");c&&c.multifile(a)},setFilter:function(a){var b=this,c=b.get("swfUploader");return b.getFilter(a),c&&c.filter([a]),a}},{ATTRS:{swfUploader:{},flash:{value:{src:seajs.pluginSDK.config.base+"uploader/uploader.swf",params:{allowscriptaccess:"always",bgcolor:"#fff",wmode:"transparent",flashvars:{hand:!0,btn:!0,jsEntry:"BUI.AJBridge.eventHandler"}}}},swfTpl:{view:!0,value:'<div class="uploader-button-swf"></div>'},xview:{value:f}}},{xclass:"uploader-swfButton"});return g}),define("bui/uploader/type/base",function(){function a(b){var c=this;a.superclass.constructor.call(c,b)}return a.ATTRS={file:{},url:{},data:{},fileDataName:{value:"Filedata"}},BUI.mix(a,{event:{START:"start",CANCEL:"cancel",SUCCESS:"success",ERROR:"error"}}),BUI.extend(a,BUI.Base,{upload:function(){},cancel:function(){},_processResponse:function(a){var b,c=this;if(c.get("file"),BUI.isString(a))try{b=BUI.JSON.parse(a)}catch(d){b=a}else BUI.isObject(a)&&(b=c._fromUnicode(a));return BUI.log("\u670d\u52a1\u5668\u7aef\u8f93\u51fa\uff1a"+BUI.JSON.stringify(b)),b},_fromUnicode:function(a){function b(a){BUI.each(a,function(c,d){BUI.isObject(a[d])?b(a[d]):a[d]=BUI.isString(c)&&BUI.fromUnicode(c)||c})}return BUI.isObject(a)?(b(a),a):a},clear:function(){}}),a}),define("bui/uploader/type/ajax",function(a){function b(a){var c=this;b.superclass.constructor.call(c,a)}var c="[uploader-AjaxType]:",d=a("bui/uploader/type/base");return BUI.mix(b,{event:BUI.merge(d.event,{PROGRESS:"progress"})}),BUI.extend(b,d,{upload:function(a){if(!a||!a.file)return BUI.log(c+"upload()\uff0cfileData\u53c2\u6570\u6709\u8bef\uff01"),!1;var b=this;return b.set("file",a),b.fire(d.event.START,{file:a}),b._setFormData(),b._addFileData(a.file),b.send(),b},cancel:function(){var a=this,c=a.get("xhr"),d=a.get("file");return c&&(c.abort(),a.fire(b.event.CANCEL,{file:d})),a.set("file",null),a},send:function(){var a=this,c=a.get("url"),d=a.get("formData"),e=a.get("file"),f=new XMLHttpRequest;return f.upload.addEventListener("progress",function(c){a.fire(b.event.PROGRESS,{loaded:c.loaded,total:c.total})}),f.onload=function(){var b=a._processResponse(f.responseText);a.fire("complete",{result:b,file:e})},f.onerror=function(){a.fire(b.event.ERROR,{file:e})},f.open("POST",c,!0),d.append("type","ajax"),f.send(d),a._setFormData(),a.set("xhr",f),a},clear:function(){},_setFormData:function(){var a=this;try{a.set("formData",new FormData),a._processData()}catch(b){BUI.log(c+"something error when reset FormData."),BUI.log(b,"dir")}},_processData:function(){var a=this,b=a.get("data"),c=a.get("formData");BUI.each(b,function(a,b){c.append(b,a)}),a.set("formData",c)},_addFileData:function(a){if(!a)return BUI.log(c+"_addFileData()\uff0cfile\u53c2\u6570\u6709\u8bef\uff01"),!1;var b=this,d=b.get("formData"),e=b.get("fileDataName");d.append(e,a),b.set("formData",d)}},{ATTRS:{formData:{},data:{},xhr:{}}}),b}),define("bui/uploader/type/flash",function(a){function b(a){var c=this;b.superclass.constructor.call(c,a),c.isHasCrossdomain()}var c="[uploader-FlashType]:",d=a("bui/uploader/type/base");return BUI.mix(b,{event:BUI.merge(d.event,{SWF_READY:"swfReady",PROGRESS:"progress"})}),BUI.extend(b,d,{_initSwfUploader:function(){var a=this,e=a.get("swfUploader");return e?(e.on("contentReady",function(){a.fire(b.event.SWF_READY)}),e.on("uploadStart",function(){var b=a.get("file");a.fire(d.event.START,{file:b})}),e.on("uploadProgress",function(d){BUI.mix(d,{loaded:d.bytesLoaded,total:d.bytesTotal}),BUI.log(c+"\u5df2\u7ecf\u4e0a\u4f20\u5b57\u8282\u6570\u4e3a\uff1a"+d.bytesLoaded),a.fire(b.event.PROGRESS,{loaded:d.loaded,total:d.total})}),e.on("uploadCompleteData",function(b){var c=a.get("file"),d=a._processResponse(b.data);a.fire("complete",{result:d,file:c}),a.set("file",null)}),e.on("uploadError",function(){var c=a.get("file");a.fire(b.event.ERROR,{file:c}),a.set("file",null)}),void 0):(BUI.log(c+"swfUploader\u5bf9\u8c61\u4e3a\u7a7a\uff01"),!1)},upload:function(a){var b=this,c=b.get("swfUploader"),d=b.get("url"),e="POST",f=b.get("data"),g=b.get("fileDataName");if(a)return b.set("file",a),c.upload(a.id,d,e,f,g),b},cancel:function(){var a=this,c=a.get("swfUploader"),d=a.get("file");return d&&(c.cancel(d.id),a.fire(b.event.CANCEL,{file:d}),a.set("file",null)),a},clear:function(){},isHasCrossdomain:function(){var a=location.hostname;$.ajax({url:"http://"+a+"/crossdomain.xml",dataType:"xml",error:function(){BUI.log("\u7f3a\u5c11crossdomain.xml\u6587\u4ef6\u6216\u8be5\u6587\u4ef6\u4e0d\u5408\u6cd5\uff01")}})}},{ATTRS:{uploader:{setter:function(a){var b=this;if(a){var c=a.get("button");c.on("swfReady",function(a){b.set("swfUploader",a.swfUploader),b._initSwfUploader()})}}},url:{getter:function(a){var b=/^http/;if(!b.test(a)){var c,d=location.href,e=d.split("/");c=BUI.Array.filter(e,function(a,b){return b<e.length-1}),a=c.join("/")+"/"+a}return a}},fileDataName:{value:"Filedata"},swfUploader:{},uploadingId:{}}}),b}),define("bui/uploader/queue",["bui/list"],function(a){var b=a("bui/common"),c=a("bui/list/simplelist"),d=b.prefix+"queue",e=d+"-item",f=c.extend({bindUI:function(){var a=this,b=a.get("el"),c=a.get("delCls");b.delegate("."+c,"click",function(b){var c=$(b.target).parent(),d=a.get("uploader"),e=a.getItemByElement(c);d&&d.cancel&&d.cancel(e),a.removeItem(e)})},updateFileStatus:function(a,c,d){var e=this,f=e.get("itemStatusFields");d=d||e.findElement(a),b.each(f,function(b,c){e.setItemStatus(a,c,!1,d)}),e.setItemStatus(a,c,!0,d),e.updateItem(a)}},{ATTRS:{itemTpl:{value:'<li><span data-url="{url}">{name}</span><div class="progress"><div class="bar" style="width:{loadedPercent}%"></div></div><div class="'+e+'-del">\u5220\u9664</div></li>'},itemCls:{value:e},delCls:{value:e+"-del"},itemStatusFields:{value:{wait:"wait",start:"start",progress:"progress",success:"success",cancel:"cancel",error:"error"}}}},{xclass:"queue"});return f}),define("bui/uploader/theme",function(a){var b=a("bui/common"),c={},d={addTheme:function(a,b){c[a]=b},getTheme:function(a){return b.cloneObject(c[a])}};return d.addTheme("default",{button:{elCls:"defaultTheme-button"},queue:{elCls:"defaultTheme-queue"}}),d}),define("bui/uploader/factory",function(a){function b(){}var c=(a("bui/common"),a("bui/uploader/queue")),d=a("bui/uploader/button/htmlButton"),e=a("bui/uploader/button/swfButton"),f=a("bui/uploader/type/ajax"),g=a("bui/uploader/type/flash");return b.prototype={createUploadType:function(a,b){return"ajax"===a?new f(b):new g(b)},createButton:function(a,b){return"ajax"===a||"iframe"===a?new d(b):new e(b)},createQueue:function(a){return new c(a)}},new b}),define("bui/uploader/uploader",function(a){var b=a("bui/common"),c=b.Component,d=a("bui/uploader/theme"),e=a("bui/uploader/factory"),f=window,g=c.View.extend({},{ATTRS:{}}),h=c.Controller.extend({renderUI:function(){var a=this;a._initTheme(),a._initType(),a._renderButton(),a._renderUploaderType(),a._renderQueue()},bindUI:function(){var a=this;a._bindButton(),a._bindUploaderCore(),a._bindQueue()},isSupportAjax:function(){return!!f.FormData},isSupportFlash:function(){return!0},_initTheme:function(){var a=this,c=d.getTheme(a.get("theme")),e=a.getAttrVals();b.each(c,function(c,d){void 0===e[d]?a.set(d,c):b.isObject(c)&&(b.mix(c,e[d]),a.set(d,c))})},_initType:function(){var a=this,b=a.get("types"),c=a.get("type");c||(c=a.isSupportAjax()?b.AJAX:a.isSupportFlash()?b.FLASH:b.IFRAME),a.set("type",c)},_getUserConfig:function(a){var c=this.getAttrVals(),d={};return b.each(a,function(a){var b=c[a];void 0!==b&&(d[a]=b)}),d},_renderUploaderType:function(){var a=this,b=a.get("type"),c=a._getUserConfig(["url","data"]),d=e.createUploadType(b,c);d.set("uploader",a),a.set("uploaderType",d)},_renderButton:function(){var a=this,b=a.get("type"),d=a.get("el"),f=a.get("button")||{};f instanceof c.Controller||(f.render=d,f.autoRender=!0,f=e.createButton(b,f),a.set("button",f)),f.set("uploader",a)},_renderQueue:function(){var a=this,b=a.get("el"),d=a.get("queue")||{};d instanceof c.Controller||(d.render=b,d.autoRender=!0,d=e.createQueue(d),a.set("queue",d)),d.set("uploader",a)},_bindButton:function(){var a=this,c=a.get("button"),d=a.get("queue");a.get("uploaderType"),c.on("change",function(a){b.each(a.files,function(a){b.mix(a,{wait:!0})}),d.addItems(a.files)})},_bindQueue:function(){var a=this,b=a.get("queue");b.on("itemrendered itemupdated",function(){var c=b.getItemsByStatus("wait");c&&c.length&&a.uploadFile(c[0])})},_bindUploaderCore:function(){var a=this,c=a.get("queue"),d=a.get("uploaderType");d.on("start",function(b){a.fire("start",{item:b.file})}),d.on("progress",function(d){var e=a.get("curUploadItem"),f=d.loaded,g=d.total;b.mix(e,{loaded:f,total:g,loadedPercent:100*f/g}),c.updateFileStatus(e,"progress"),a.fire("progress",{item:e,total:g,loaded:f})}),d.on("error",function(){var d=a.get("curUploadItem"),e=a.get("error"),f=a.get("complete");c.updateFileStatus(d,"error"),e&&b.isFunction(e)&&e.call(a),a.fire("error",{item:d}),f&&b.isFunction(f)&&f.call(a),a.fire("complete",{item:d}),a.set("curUploadItem",null)}),d.on("complete",function(d){var e=a.get("curUploadItem"),f=d.result,g=a.get("isSuccess"),h=a.get("success"),i=a.get("error"),j=a.get("complete");e.result=f,g.call(a,f)?(c.updateFileStatus(e,"success"),h&&b.isFunction(h)&&h.call(a,f),a.fire("success",{item:e,result:f})):(c.updateFileStatus(e,"error"),i&&b.isFunction(i)&&i.call(a,f),a.fire("error",{item:e,result:f})),j&&b.isFunction(j)&&j.call(a,f),a.fire("complete",{item:e,result:f}),a.set("curUploadItem",null),a.uploadFiles()})},uploadFile:function(a){var b=this,c=b.get("queue"),d=b.get("uploaderType"),e=b.get("curUploadItem");a&&!e&&(b.set("curUploadItem",a),c.updateFileStatus(a,"start"),d.upload(a))},uploadFiles:function(){var a=this,b=a.get("queue"),c=b.getItemsByStatus("wait");c&&c.length&&a.uploadFile(c[0])},cancel:function(){var a=this,b=a.get("uploaderType"),c=a.get("curUploadItem");a.fire("cancel",{item:c}),b.cancel(),a.set("curUploadItem",null)}},{ATTRS:{types:{value:{AJAX:"ajax",FLASH:"flash",IFRAME:"iframe"}},type:{},theme:{value:"default"},button:{},queue:{},uploadStatus:{},isSuccess:{value:function(a){return a&&a.url?!0:!1}},success:{},error:{},complete:{},xview:{value:g}}},{xclass:"uploader"});return h}),define("bui/uploader",function(a){var b=a("bui/common"),c=b.namespace("Uploader");return b.mix(c,{Uploader:a("bui/uploader/uploader"),Queue:a("bui/uploader/queue"),Theme:a("bui/uploader/theme"),Factory:a("bui/uploader/factory")}),c});