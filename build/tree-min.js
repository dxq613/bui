/*! BUI - v0.1.0 - 2013-11-18
* https://github.com/dxq613/bui
* Copyright (c) 2013 dxq613; Licensed MIT */
define("bui/tree",["bui/common","bui/tree/treemixin","bui/tree/treelist","bui/tree/treemenu"],function(a){var b=a("bui/common"),c=b.namespace("Tree");return b.mix(c,{TreeList:a("bui/tree/treelist"),Mixin:a("bui/tree/treemixin"),TreeMenu:a("bui/tree/treemenu")}),c}),define("bui/tree/treemixin",["bui/common","bui/data"],function(a){function b(a,b){return c.isString(b)&&(b=a.findNode(b)),b}var c=a("bui/common"),d=a("bui/data"),e="expanded",f="loading",g="checked",h="partial-checked",i={NONE:"none",ALL:"all",CUSTOM:"custom",ONLY_LEAF:"onlyLeaf"},j="x-tree-icon",k="x-tree-elbow",l="x-tree-show-line",m=k+"-",n=j+"-wraper",o=m+"line",p=m+"end",q=m+"empty",r=m+"expander",s=j+"-checkbox",t=j+"-radio",u=r+"-end",v=function(){};return v.ATTRS={store:{getter:function(a){if(!a){var b=this,c=new d.TreeStore({root:b.get("root"),data:b.get("nodes")});return b.setInternal("store",c),c}return a}},root:{},nodes:{sync:!1},iconContainer:{},iconWraperTpl:{value:'<span class="'+n+'">{icons}</span>'},showLine:{value:!1},showIcons:{value:!0},iconTpl:{value:'<span class="x-tree-icon {cls}"></span>'},leafCls:{value:m+"leaf"},dirCls:{value:m+"dir"},checkType:{value:"custom"},accordion:{value:!1},multipleCheck:{value:!0},checkedField:{valueFn:function(){return this.getStatusField("checked")}},checkableField:{value:"checkable"},itemStatusFields:{value:{expanded:"expanded",disabled:"disabled",checked:"checked"}},dirSelectable:{value:!0},showRoot:{value:!1},events:{value:{expanded:!1,collapsed:!1,checkedchange:!1}},expandEvent:{value:"itemdblclick"},expandAnimate:{value:!1},collapseEvent:{value:"itemdblclick"},startLevel:{value:1}},c.augment(v,{collapseAll:function(){var a=this,b=a.get("view").getAllElements();c.each(b,function(b){var c=a.getItemByElement(b);c&&a._collapseNode(c,b,!0)})},collapseNode:function(a){var b,d=this;c.isString(a)&&(a=d.findNode(a)),a&&(b=d.findElement(a),d._collapseNode(a,b))},expandAll:function(){var a=this,b=a.get("view").getAllElements();c.each(b,function(b){var c=a.getItemByElement(b);a._expandNode(c,b,!0)})},expandNode:function(a,b){var d,e=this;c.isString(a)&&(a=e.findNode(a)),a&&(a.parent&&!e.isExpanded(a.parent)&&e.expandNode(a.parent),d=e.findElement(a),e._expandNode(a,d,b))},expandPath:function(a,b,c){if(a){c=c||0;var d,e,f,g,h=this,i=h.get("store"),j=a.split(",");for(d=h.findNode(j[c]),f=c+1;f<j.length;f++)if(g=j[f],e=h.findNode(g,d),d&&e)h.expandNode(d),d=e;else if(d&&b){i.load({id:d.id},function(){e=h.findNode(g,d),e&&h.expandPath(a,b,f)});break}}},findNode:function(a,b){return this.get("store").findNode(a,b)},getCheckedLeaf:function(a){var b=this,c=b.get("store");return c.findNodesBy(function(a){return a.leaf&&b.isChecked(a)},a)},getCheckedNodes:function(a){var b=this,c=b.get("store");return c.findNodesBy(function(a){return b.isChecked(a)},a)},isItemSelectable:function(a){var b=this,c=b.get("dirSelectable"),d=a;return!d||c||d.leaf?!0:!1},isExpanded:function(a){if(!a||a.leaf)return!1;var b,d=this;return d._isRoot(a)&&!d.get("showRoot")?!0:(c.isString(a)&&(item=d.getItem(a)),b=d.findElement(a),this._isExpanded(a,b))},isChecked:function(a){return a?!!a[this.get("checkedField")]:!1},toggleExpand:function(a){var b,d=this;c.isString(a)&&(item=d.getItem(a)),b=d.findElement(a),d._toggleExpand(a,b)},setNodeChecked:function(a,d,e){if(e=null==e?!0:e,a){var f,h,i=this,j=i.get("multipleCheck");if(a=b(this,a),a&&(f=a.parent,i.isCheckable(a))){if(i.isChecked(a)!==d||i.hasStatus(a,"checked")!==d){if(h=i.findElement(a),h?(i.setItemStatus(a,g,d,h),j?i._resetPatialChecked(a,d,d,h):d&&f&&i.isChecked(f)!=d&&i.setNodeChecked(f,d,!1)):i.isItemDisabled(a)||i.setStatusValue(a,"checked",d),f&&(i.isChecked(f)!=d?i._resetParentChecked(f):j&&i._resetPatialChecked(f,null,null,null,!0)),d&&!j&&(i.isChecked(f)||f==i.get("root"))){var k=f.children;c.each(k,function(b){b!==a&&i.isChecked(b)&&i.setNodeChecked(b,!1)})}i.fire("checkedchange",{node:a,element:h,checked:d})}!a.leaf&&e&&c.each(a.children,function(a,b){(j||!d||!j&&0==b)&&i.setNodeChecked(a,d,e)})}}},setChecked:function(a){this.setNodeChecked(a,!0)},clearAllChecked:function(){var a=this,b=a.getCheckedNodes();c.each(b,function(b){a.setNodeChecked(b,!1)})},_initRoot:function(){var a,b,d=this,e=d.get("store"),f=d.get("showRoot");e&&(a=e.get("root"),d.setInternal("root",a),b=f?[a]:a.children,c.each(b,function(a){d._initChecked(a,!0)}),d.clearItems(),d.addItems(b))},_initChecked:function(a,b){var d,e=this,f=e.get("checkType"),g=e.get("checkedField"),h=e.get("multipleCheck"),j=e.get("checkableField");return f===i.NONE?(a[j]=!1,a[g]=!1,void 0):f===i.ONLY_LEAF?(a.leaf?a[j]=!0:(a[j]=!1,a[g]=!1,b&&c.each(a.children,function(a){e._initChecked(a,b)})),void 0):(f===i.CUSTOM&&null==a[j]&&(a[j]=null!=a[g]),f===i.ALL&&(a[j]=!0),a&&e.isCheckable(a)&&(d=a.parent,e.isChecked(a)||(d&&e.isChecked(d)&&(h||!e._hasChildChecked(d))&&e.setStatusValue(a,"checked",!0),(a.children&&a.children.length&&e._isAllChildrenChecked(a)||!h&&e._hasChildChecked(a))&&e.setStatusValue(a,"checked",!0)),b&&c.each(a.children,function(a){e._initChecked(a,b)})),void 0)},_resetPatialChecked:function(a,b,c,d,e){if(!a||a.leaf)return!0;var c,f=this;return(b=null==b?f.isChecked(a):b)?(f.setItemStatus(a,h,!1,d),void 0):(c=null==c?f._hasChildChecked(a):c,f.setItemStatus(a,h,c,d),e&&a.parent&&f._resetPatialChecked(a.parent,!1,c?c:null,null,e),void 0)},_resetParentChecked:function(a){if(this.isCheckable(a)){var b=this,c=b.get("multipleCheck"),d=c?b._isAllChildrenChecked(a):b._hasChildChecked(a);b.setStatusValue(a,"checked",d),b.setNodeChecked(a,d,!1),c&&b._resetPatialChecked(a,d,null,null)}},__bindUI:function(){var a=this,b=(a.get("el"),a.get("multipleCheck"));a.on("itemclick",function(b){var c=$(b.domTarget),d=b.element,e=b.item;if(c.hasClass(r))return a._toggleExpand(e,d),!1;if(c.hasClass(s)){var f=a.isChecked(e);a.setNodeChecked(e,!f)}else c.hasClass(t)&&a.setNodeChecked(e,!0)}),a.on("itemrendered",function(c){var d=c.item,e=c.domTarget;a._resetIcons(d,e),a.isCheckable(d)&&b&&a._resetPatialChecked(d,null,null,e),a._isExpanded(d,e)&&a._showChildren(d)}),a._initExpandEvent()},_initExpandEvent:function(){function a(a){return function(c){var d=$(c.domTarget),e=c.element,f=c.item;d.hasClass(r)||b[a](f,e)}}var b=this,c=(b.get("el"),b.get("expandEvent")),d=b.get("collapseEvent");c==d?b.on(c,a("_toggleExpand")):(c&&b.on(c,a("_expandNode")),d&&b.on(d,a("_collapseNode")))},_isForceChecked:function(){var a=this,b=a.get("multipleCheck");return b?a._isAllChildrenChecked():_isForceChecked()},_isAllChildrenChecked:function(a){if(!a||a.leaf)return!1;var b=this,d=a.children,e=!0;return c.each(d,function(a){return e=e&&b.isChecked(a),e?void 0:!1}),e},_hasChildChecked:function(a){if(!a||a.leaf)return!1;var b=this;return 0!=b.getCheckedNodes(a).length},_isRoot:function(a){var b=this,c=b.get("store");return c&&c.get("root")==a?!0:!1},_setLoadStatus:function(a,b,c){var d=this;d.setItemStatus(a,f,c,b)},_beforeLoadNode:function(a){var b,d=this;c.isString(a)&&(a=d.findNode(a)),b=d.findElement(a),b?(d._collapseNode(a,b),d._setLoadStatus(a,b,!0)):a&&c.each(a.children,function(a){d._removeNode(a)})},onBeforeLoad:function(a){var b=this,c=a.params,d=c.id,e=b.findNode(d)||b.get("root");b._beforeLoadNode(e)},_addNode:function(a,b){var c,d,e,f=this,g=a.parent;f._initChecked(a,!0),g?(f.isExpanded(g)&&(c=g.children.length,e=f._getInsetIndex(a),f.addItemAt(a,e),b==c-1&&b>0&&(d=g.children[b-1],f._updateIcons(d))),f._updateIcons(g)):(e=f._getInsetIndex(a),f.addItemAt(a,e),d=f.get("nodes")[b-1],f._updateIcons(d))},_getInsetIndex:function(a){var b,c=this;return b=c._getNextItem(a),b?c.indexOfItem(b):c.getItemCount()},_getNextItem:function(a){var b,d,e=this,f=a.parent,g=null;return f?(b=f.children,d=c.Array.indexOf(a,b),g=b[d+1],g||e._getNextItem(f)):null},onAdd:function(a){var b=this,c=a.node,d=a.index;b._addNode(c,d)},_updateNode:function(a){var b=this;b.updateItem(a),b._updateIcons(a)},onUpdate:function(a){var b=this,c=a.node;b._updateNode(c)},_removeNode:function(a,b){var c,d,e=this,f=a.parent;e.collapseNode(a),f&&(e.removeItem(a),e.isExpanded(f)&&(c=f.children.length,c==b&&0!==b&&(d=f.children[b-1],e._updateIcons(d))),e._updateIcons(f),e._resetParentChecked(f))},onRemove:function(a){var b=this,c=a.node,d=a.index;b._removeNode(c,d)},_loadNode:function(a){var b=this;b._initChecked(a,!0),b.expandNode(a),b._updateIcons(a),b.setItemStatus(a,f,!1)},__syncUI:function(){var a=this,b=a.get("store"),c=a.get("showRoot");c&&!b.hasData()&&a._initRoot()},onLoad:function(a){var b=this,c=b.get("store"),d=c.get("root");a&&a.node!=d||b._initRoot(),a&&a.node&&b._loadNode(a.node)},_isExpanded:function(a,b){return this.hasStatus(a,e,b)},_getIconsTpl:function(a){var b,d=this,e=a.level,f=d.get("startLevel"),g=d.get("iconWraperTpl"),h=[];for(b=f;e>b;b+=1)h.push(d._getLevelIcon(a,b));return h.push(d._getExpandIcon(a)),h.push(d._getCheckedIcon(a)),h.push(d._getNodeTypeIcon(a)),c.substitute(g,{icons:h.join("")})},_getCheckedIcon:function(a){var b,c=this,d=c.isCheckable(a);return d?(b=c.get("multipleCheck")?s:t,c._getIcon(b)):""},isCheckable:function(a){return a[this.get("checkableField")]},_getExpandIcon:function(a){var b=this,c=r;return a.leaf?b._getLevelIcon(a):(b._isLastNode(a)&&(c=c+" "+u),b._getIcon(c))},_getNodeTypeIcon:function(a){var b=this,c=a.cls?a.cls:a.leaf?b.get("leafCls"):b.get("dirCls");return b._getIcon(c)},_getLevelIcon:function(a,b){var c,d=this,e=d.get("showLine"),f=q;return e&&(a.level===b||null==b?f=d._isLastNode(a)?p:k:(c=d._getParentNode(a,b),f=d._isLastNode(c)?q:o)),d._getIcon(f)},_getParentNode:function(a,b){var c=a.level,d=a.parent,e=c-1;if(b>=c)return null;for(;e>b;)d=d.parent,e-=1;return d},_getIcon:function(a){var b=this,d=b.get("iconTpl");return c.substitute(d,{cls:a})},_isLastNode:function(a){if(!a)return!1;if(a==this.get("root"))return!0;var b,c=this,d=a.parent,e=d?d.children:c.get("nodes");return b=e.length,e[b-1]===a},_initNodes:function(a,b,d){var e=this;c.each(a,function(a){a.level=b,null==a.leaf&&(a.leaf=a.children?!1:!0),d&&!a.parent&&(a.parent=d),e._initChecked(a),a.children&&e._initNodes(a.children,b+1,a)})},_collapseNode:function(a,b,c){var d=this;a.leaf||d.hasStatus(a,e,b)&&(d.setItemStatus(a,e,!1,b),c?(d._collapseChildren(a,c),d.removeItems(a.children)):d._hideChildrenNodes(a),d.fire("collapsed",{node:a,element:b}))},_hideChildrenNodes:function(a){var b=this,d=a.children,e=[];c.each(d,function(a){var c=b.findElement(a);c&&(e.push(c),b._hideChildrenNodes(a))}),b.get("expandAnimate")?(e=$(e),e.animate({height:0},function(){b.removeItems(d)})):b.removeItems(d)},_collapseChildren:function(a,b){var d=this,e=a.children;c.each(e,function(a){d.collapseNode(a,b)})},_expandNode:function(a,b,d){var f=this,g=f.get("accordion"),h=f.get("store");if(!a.leaf){if(!f.hasStatus(a,e,b)){if(g&&a.parent){var i=a.parent.children;c.each(i,function(b){b!=a&&f.collapseNode(b)})}h&&!h.isLoaded(a)?f._isLoading(a,b)||h.loadNode(a):b&&(f.setItemStatus(a,e,!0,b),f._showChildren(a),f.fire("expanded",{node:a,element:b}))}c.each(a.children,function(a){(d||f.isExpanded(a))&&f.expandNode(a,d)})}},_showChildren:function(a){if(a&&a.children){var b,c=this,d=c.indexOfItem(a),e=a.children.length,f=e-1;for(f=e-1;f>=0;f--)b=a.children[f],c.getItem(b)||(c.get("expandAnimate")?(el=c._addNodeAt(b,d+1),el.hide(),el.slideDown()):c.addItemAt(b,d+1))}},_addNodeAt:function(a,b){var c=this,d=c.get("items");return void 0===b&&(b=d.length),d.splice(b,0,a),c.addItemToView(a,b)},_isLoading:function(a,b){var c=this;return c.hasStatus(a,f,b)},_resetIcons:function(a,b){if(this.get("showIcons")){var c,d=this,e=d.get("iconContainer"),f=d._getIconsTpl(a);$(b).find("."+n).remove(),c=$(b).find(e).first(),e&&c.length?$(f).prependTo(c):$(b).prepend($(f))}},_toggleExpand:function(a,b){var c=this;c._isExpanded(a,b)?c._collapseNode(a,b):c._expandNode(a,b)},_updateIcons:function(a){var b=this,d=b.findElement(a);d&&(b._resetIcons(a,d),b._isExpanded(a,d)&&!a.leaf&&c.each(a.children,function(a){b._updateIcons(a)}))},_uiSetShowRoot:function(){var a=this,b=this.get("showRoot")?0:1;a.set("startLevel",b)},_uiSetNodes:function(a){var b=this,c=b.get("store");c.setResult(a)},_uiSetShowLine:function(a){var b=this,c=b.get("el");a?c.addClass(l):c.removeClass(l)}}),v}),define("bui/tree/treelist",["bui/common","bui/list","bui/tree/treemixin"],function(a){var b=a("bui/common"),c=a("bui/list"),d=a("bui/tree/treemixin"),e=c.SimpleList.extend([d],{},{ATTRS:{itemCls:{value:b.prefix+"tree-item"},itemTpl:{value:"<li>{text}</li>"},idField:{value:"id"}}},{xclass:"tree-list"});return e});